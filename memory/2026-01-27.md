# 2026-01-27 â€” Session Notes

## Photo â†’ CMMS Bot Built & Launched
- **Built `photo_to_cmms_bot.py`** at `C:\Users\hharp\clawd\projects\rivet-pro\photo_to_cmms_bot.py`
- Flow: Telegram photo â†’ Gemini 2.5 Flash vision analysis â†’ Atlas CMMS asset creation â†’ work order creation â†’ formatted reply
- **Bot token:** 7855741814 (@testbotrivet_bot) â€” separate from Clawdbot's token (8519329029)
- **CMMS:** Atlas CMMS running on VPS at `http://72.60.175.144:8080` (Docker container `atlas-cmms`)
  - Auth: POST /auth/signin with `{email, password, type:"client"}` â†’ accessToken
  - Password: `Bo1ws2er@12` (the `@` is required â€” `Bo1ws2er12` without it fails)
- **Gemini:** Using deprecated `google.generativeai` package â€” should migrate to `google.genai` eventually
- Bot launched successfully as background process (session: lucky-daisy, PID 6148)
- Mike's goal: demo for his wife in 30 minutes â€” photo of equipment â†’ auto work order

## Infrastructure Notes
- **No Docker Desktop locally** â€” Docker commands fail on Mike's laptop
- **No CMMS locally** (localhost:8081 refused) â€” all CMMS is on VPS
- VPS also runs: Redis (6379), PostgreSQL/pgvector (5432), Atlas frontend (3000)
- Clawdbot gateway PID 31164, model claude-opus-4-5

## CMMS Password Reset
- Old password: `Bo1ws2er@12` â†’ **DEAD, no longer works**
- New password: `CraneSync2026!`
- Reset via: Direct BCrypt update in Neon cloud DB
- DB: `postgresql://neondb_owner:npg_c3UNa4KOlCeL@ep-purple-hall-ahimeyn0-pooler.c-3.us-east-1.aws.neon.tech/atlas_cmms`
- User ID: 76 (mike@cranesync.com, Administrator)
- Bot env file updated and restarted

## Sub-agent Spawned
- `cmms-bot-build` sub-agent was too slow, built the bot manually instead
- Lesson: for 30-min sprints, just do it yourself rather than spawning sub-agents

## Key API Endpoints (Atlas CMMS)
- `POST /auth/signin` â†’ `{accessToken}`
- `POST /assets` â†’ create asset (payload: `{name, description, model, area, status}`)
- `GET /assets/mini` â†’ list all assets (mini format)
- `POST /assets/search` â†’ search assets (paginated: `{filterFields, pageNum, pageSize}`)
- `POST /work-orders` â†’ create work order (payload: `{title, description, priority, status, category, asset:{id}}`)
- `POST /work-orders/search` â†’ search WOs (paginated)
- **NOTE:** `GET /assets` returns 405! Use `/assets/mini` or `POST /assets/search`

## Production Hardening (05:20 session)

### What was wrong
- Bot ran on Mike's laptop â†’ dies when laptop sleeps
- VPS had old `rivet-pro-bot.service` polling same token â†’ 409 Conflict
- Hardcoded credentials in source
- Wrong CMMS list endpoints (GET /assets â†’ 405)
- No dedup â†’ created duplicate Micro820 assets (#147, #149)
- No auth, rate limiting, or file logging

### What was fixed
1. **Full production rewrite** of `photo_to_cmms_bot.py`:
   - Env-var config (no hardcoded secrets)
   - Correct CMMS endpoints (`GET /assets/mini`, `POST /*/search`)
   - Asset dedup via cache (checks before creating)
   - User allowlisting (only Mike's Telegram ID)
   - Rate limiting (30/hour per user)
   - Rotating file + console logging
   - Graceful error handling (no internal leaks)
   - Commands: /start, /status, /assets, /recent
   - On Conflict error: hard exit â†’ systemd restarts clean
2. **Deployed to VPS** as systemd service:
   - Path: `/opt/plc-copilot/photo_to_cmms_bot.py`
   - Env: `/opt/plc-copilot/.env`
   - Service: `plc-copilot.service` (enabled, auto-restart)
   - Logs: `/var/log/plc-copilot/` (rotating)
   - CMMS: `http://localhost:8080` (same VPS)
3. **Disabled old service** (`rivet-pro-bot.service`)
4. Asset cache: 29 existing assets loaded on startup

## Additional Fixes (06:00-07:16 session)

### WO Creation 500 Bug
- `category` field sent as string `"CORRECTIVE"` but Atlas expects an object or null
- Fix: removed `category` and `status` from WO payload â€” both default server-side
- Verified: WOs now create successfully (tested with Nextys PSU â†’ WO created + asset #150)

### CMMS Frontend Login Broken â€” FIXED
- **Root cause 1:** `runtime-env.js` had `API_URL: "https://cmms.maintnpc.com"` â€” dead domain
- **Root cause 2:** When changed to `http://72.60.175.144:8080`, CORS blocked cross-origin requests
- **Fix:** Set `API_URL` to `http://72.60.175.144` (same origin via Caddy proxy, which routes `/auth/*`, `/assets/*`, `/work-orders/*` etc. to backend on :8080)
- **Made permanent:** Recreated `atlas-frontend` Docker container with env vars (`-e API_URL=http://72.60.175.144` etc.) so `runtime-env-cra` generates correct config on every container start
- Login tested live via browser automation: âœ… works

### Watchdog Fix
- systemd `WatchdogSec=120` was killing bot every 2 min (Python doesn't send sd_notify)
- Removed WatchdogSec from service file â€” bot now runs indefinitely

### Telegram Bot Commands Updated
- Old menu had 12+ commands from previous bot (/help, /menu, /chat, /manual, etc.)
- Updated via `setMyCommands` API to: /start, /status, /assets, /recent

### Deep Links Added
- Bot responses now include clickable links:
  - ðŸ”— View Work Order â†’ `http://72.60.175.144/app/work-orders/{id}`
  - ðŸ”— View Asset â†’ `http://72.60.175.144/app/assets/{id}`
- Atlas CMMS frontend routes: `/app/work-orders/:workOrderId`, `/app/assets/:assetId`

### Git Pushed
- Committed to `Mikecranesync/Rivet-PRO` main branch (hash: 12be813)
- Files: photo_to_cmms_bot.py, deploy/plc-copilot.service, deploy/plc-copilot.env, deploy/nginx-cmms.conf
- Mike wants regular GitHub commits going forward

## Freemium Registration System (07:30-08:10 EST)

### Built & Deployed
1. **Registration page** at `http://72.60.175.144/register`
   - Dark industrial theme (navy #1a1a2e + orange #ff6b35), mobile-first
   - Branding: **Maint-NPC** (inside joke â€” the maintenance NPC)
   - Multi-step: form â†’ OTP verification â†’ success
2. **FastAPI registration API** (port 8000, systemd `plc-registration.service`)
   - Endpoints: /api/register, /api/verify-otp, /api/resend-otp, /api/link-telegram, /api/user/{tg_id}
   - SQLite DB at `/opt/plc-copilot/users.db`
3. **Twilio Verify API** for phone OTP
   - Account SID: AC55abcf49ca17a755c6ff30f279b89c2f
   - Auth Token: 8cc6d286bac2fe033df7d49eb957efbc (updated â€” old one was expired)
   - Verify Service SID: VAaf4e29f1d81b6fa33ce8646852826962
   - **Important:** Cannot use `custom_code` parameter on basic Twilio accounts (error 60204). Must let Twilio generate OTP and use their verify check endpoint.
4. **SMS drip campaign** â€” welcome + Day 2 + Day 5 messages (background worker)
5. **Caddy routes** â€” registration routes placed BEFORE generic `/api/*` to avoid CMMS backend catching them

### Bot Freemium Gate
- Removed `ALLOWED_USERS` allowlist â€” bot open to ALL Telegram users
- 3 free photo analyses per user (tracked in SQLite `telegram_usage` table)
- After 3: registration wall with inline button â†’ `http://72.60.175.144/register?tg={id}`
- Usage counter shown after each photo ("2/3 free scans remaining")
- New commands: /register, updated /start and /status with account info
- Bot startup log now says "Mode: Freemium (3 free photos, then registration)"

### Mike's Registration Test
- Phone: +18636517679
- Hit "custom_code not allowed" error â†’ fixed by using Twilio's built-in OTP
- Added `verify_otp_code()` method to sms_service.py for Twilio verify check
- Added `verify_user()` method to user_db.py

### Caddy Route Ordering (Critical)
- Registration `/api/register*` etc. MUST be BEFORE generic `/api/*` (CMMS backend)
- Otherwise Caddy sends registration requests to Atlas CMMS port 8080

### MUI X Watermark Fix
- Injected `setInterval` script into `index.html` to hide MUI DataGrid "Missing license key" watermark
- Created `cmms-frontend-patch.service` (systemd oneshot) to re-inject after container restarts
- CSS selector didn't work because element has inline styles; JS `querySelector` with `setInterval` works

### Git Commits
- `12be813` â€” Photoâ†’CMMS bot + deploy configs
- `33375c9` â€” Freemium registration system
- `769e902` â€” Freemium gate on bot

## KB Harvester (08:30 EST â€” In Progress)
- Mike wants 24/7 knowledge base builder to make Maint-NPC the ultimate industrial maintenance NPC
- Existing KB enrichment pipeline in `rivet_pro/` codebase (234+ tests, never deployed)
- Sub-agent `kb-harvester-build` spawned to create standalone harvester
- **Data sources:** Reddit (r/PLC, r/electricians, r/maintenance, etc.), manufacturer fault codes (AB, Siemens, ABB, Yaskawa, Danfoss, SEW, Schneider), structured seed data (500+ entries), public manuals
- **Goal:** Day 1 = 500+ built-in entries. Week 1 = thousands from Reddit. Month 1 = most knowledgeable maintenance bot alive.
- Mike emphasized: cover everything from basic fuses/circuit breakers to PLC/AI level stuff. Real-world practical knowledge.

## Current State (as of 08:30 EST)
- **Bot:** Running on VPS as `plc-copilot.service` â€” freemium mode (3 free, then registration)
- **Registration API:** Running as `plc-registration.service` on port 8000
- **CMMS frontend:** Docker container with correct env vars + MUI watermark fix
- **CMMS credentials:** mike@cranesync.com / CraneSync2026!
- **Assets:** 30 in CMMS, **Work Orders:** 43+
- **GitHub:** Up to date on main branch (3 commits today)
- **Caddy:** Proxies frontend (/), API (/auth/*, /assets/*), registration (/register*, /api/register*)
- **Twilio:** Active, Verify API working for OTP
- **KB Harvester:** Building (sub-agent), not deployed yet
- **Registration URL:** http://72.60.175.144/register
- **Branding:** Maint-NPC (not MaintnPC)

## RideView Web Tool â€” Major Overhaul (13:00-14:10 EST)

### Problem Identified
- HSV-only torque stripe detection was **completely failing** â€” detecting Coca-Cola cans, multimeters, push button panel colors as "stripes"
- Algorithm had no concept of WHERE a bolt is â€” just found any orange/red/yellow in entire frame
- Results: "Stripes: 14, Continuity: 0.00" on a photo with 2 bolts â€” useless for a tech
- Mike's test rig: black DIN rail / mounting bracket with hex bolts, intentionally broken torque paint marks

### Solution: Gemini Vision Hybrid Analyzer
- **Rebuilt `analyzer.py`** â€” now uses Gemini 2.0 Flash Vision API as primary classifier
- Sends each photo to Gemini with structured prompt asking for bolt count, stripe status, PASS/FAIL/WARNING, confidence, detailed description, and maintenance recommendation
- HSV kept only as visual overlay fallback if Gemini is down
- Returns structured JSON: bolts_detected, classification, confidence, stripe_status, details, bolt_descriptions, recommendation

### Video Support Added
- New "Record Video" button (ðŸŽ¬) opens native camera in video mode
- Video uploaded â†’ frames extracted every 1 second (max 20 frames) â†’ each analyzed by Gemini
- Returns overall verdict with per-frame breakdown (PASS/FAIL/WARNING counts)
- Goal: near real-time eventually (Mike's requirement)

### Files Changed
- `C:\Users\hharp\clawd\projects\rideview\web_tool\analyzer.py` â€” complete rewrite (Gemini Vision + HSV fallback + video frame extraction)
- `C:\Users\hharp\clawd\projects\rideview\web_tool\app.py` â€” video upload handling, async analysis
- `C:\Users\hharp\clawd\projects\rideview\web_tool\templates\index.html` â€” video UI, rich metadata display

### Deployment
- Deployed to VPS: `/opt/rideview/` (analyzer.py, app.py, templates/index.html)
- Added `GEMINI_API_KEY` env var to `rideview.service`
- Service running: `systemctl restart rideview` â†’ active
- URL: https://72-60-175-144.sslip.io/inspect
- `aiohttp` installed on VPS for async Gemini API calls

### Technical Notes
- Gemini API key hardcoded as fallback in analyzer.py (same key as Photoâ†’CMMS bot)
- Result images now have: colored border (green/red/orange), status banner, confidence %, detail text overlay
- Video analysis uses `cv2.VideoCapture` for frame extraction
- The `analyze_image` sync wrapper handles FastAPI's async context via ThreadPoolExecutor

## Key Lessons
- Docker `runtime-env-cra` generates `runtime-env.js` from env vars â€” use `-e` flags, not volume mounts
- Atlas CMMS API: `category` is an object not a string; `GET /assets` is 405, use `/assets/mini`
- Telegram 409 Conflict persists for ~30s after killing a polling process; use pre-flight lock clearing
- systemd WatchdogSec requires sd_notify from the app â€” don't use it with simple Python scripts
- Always test frontend login end-to-end (browser), not just API â€” CORS, runtime config, caching all matter
- **HSV color detection is useless without ROI isolation** â€” any colored object in frame triggers false positives. Use vision AI for semantic understanding, HSV only for visual overlay within known regions.

## Overlay Iterations (14:10-15:25 EST)

### Iteration 1: Gemini bbox + HSV glow
- Asked Gemini to return bounding box percentages for each bolt
- HSV ran within those ROIs, drew glowing contours
- **Problem:** Gemini's bbox estimates were inaccurate â€” boxes landed above/left of actual bolt

### Iteration 2: Inspection window = targeting rectangle
- Made the camera viewfinder rectangle the actual crop region
- Server crops center 60%x50% for native camera photos
- Live viewfinder crops center 60%x40% on capture
- No more Gemini bbox guessing â€” whole cropped image IS the bolt region
- HSV glow runs on full cropped image

### Iteration 3: Overlay cleanup
- Text overlay covered entire photo â€” removed it (details shown in web UI below image)
- Glow was "spaghetti" â€” too many tiny contours. Added min area filter (0.1% of image)
- Single-pass blending at 30% opacity + 2px crisp outlines
- Final: clean photo with green/red glow on stripe paint, status banner, color border

## Google Photos Integration Attempt (14:30-14:50 EST)
- Mike sent OAuth2 credentials for Google Cloud project "aismartmeter"
- Set up OAuth flow, got tokens after 3 re-authorizations (API wasn't enabled, scopes not listed, etc.)
- **Discovery:** Google Photos Library API now only allows access to APP-CREATED content
- Picker API requires interactive browser selection â€” not suitable for bulk pull
- **Pivoted to Google Takeout** â€” Mike initiated export, waiting for email
- Google Photos account: harperhousebuyers@gmail.com
- OAuth tokens saved on VPS: /opt/rideview/google_auth/tokens.json
- Refresh token: 1//05Tdx-MUdb4krCgYIARAAGAUSNwF-L9IrNdNoPnstgbeu89sIAghqfiLV_1EfXTw1DQPsahMLAo2jug5QBjMHuq1JMGf-8UsT2Ek

## White Paper Created (14:30 EST)
- Sub-agent wrote WHITEPAPER.md (~35KB) â€” full R&D paper on the hybrid VLM approach
- Sections: Abstract, Intro, Related Work, Architecture, Methodology (all 6 phases), Results, Discussion, Future Work, References
- Committed to GitHub: Mikecranesync/RideView

## GitHub Push (15:27 EST)
- Commit a6fcaa1: Gemini Vision hybrid, video support, inspection window, white paper
- Commit e8f0db0: PWA support (manifest, service worker, icons)
- All pushed to main branch

## Deep Research Spawned (15:32-15:40 EST)
- Market research sub-agent: competitors, pricing, grants, patents, go-to-market â†’ MARKET_RESEARCH.md
- Technical research sub-agent: on-device ML, camera hardware, CV pipeline, offline arch â†’ TECHNICAL_RESEARCH.md
- Both completed and saved to RideView repo

## Proactive Operations Setup (15:55-16:46 EST)

### Watched TWiST E2240 â€” Clawdbot episode
- Jason Calacanis with 3 Clawdbot power users (Matt Van Horn, Alex Finn, Dan Pagin)
- Key takeaways: brain dump everything, be proactive, cron jobs for recurring work, publish skills, run business from Telegram
- Dan running parents' tea business entirely from WhatsApp + Clawdbot

### PRD Created
- PROACTIVE_OPS_PRD.md â€” full plan for Jarvis as AI Chief of Staff
- Morning brief, evening wrap, signal hunting, autonomous development, content pipeline

### Cron Jobs Set Up (adjusted for Mike's 3rd shift schedule)
- 3:00 PM EST: Morning Brief + Synchronicity Scan (Mike wakes up)
- 7:00 PM EST: Signal Hunter â€” autonomous web/Reddit/grant scan (isolated agent)
- 9:00 AM EST: Evening Wrap + Synchronicity Capture (Mike winding down)
- Every 6h: VPS health check (silent unless broken)
- Monday 4 PM: Weekly progress report

### Trello Board Created
- Board: https://trello.com/b/3lxABXX4 ("FactoryLM Command Center")
- Board ID: 69792944285b43a963e9b858
- 7 columns: Inbox, Research, Backlog, In Progress, Review/Testing, Done, Shipped
- 8 labels: RideView, Maint-NPC, FactoryLM, Infrastructure, Marketing, Revenue, Research, Bug
- 15 initial cards populated
- Trello API key + token added to Clawdbot config
- Board config saved: C:\Users\hharp\clawd\trello_board.json

### Skills Installed
- jq (via winget), ripgrep (via winget), nano-pdf (via pip)
- Already had: gh, ffmpeg, curl
- Skills now working: github, weather, video-frames, nano-pdf, session-logs, gemini, coding-agent

### PWA Deployed
- manifest.json, service worker, app icons (192px + 512px)
- RideView can now be installed to phone home screen
- Committed + pushed to GitHub (e8f0db0)

## Anonymous Identity Decision (17:48-18:54 EST)
- Mike wants to go FULLY ANONYMOUS for FactoryLM
- Reason: testing app at Universal Orlando at night â€” employer may not like it
- **Identity:** jarvis@factorylm.com
- **Domain:** factorylm.com â€” Mike tried Namecheap but locked out (password reset emails not arriving)
- Need to: buy domain (Hostinger or Porkbun if Namecheap fails), set up email, create anon GitHub org, scrub public repos
- LinkedIn profile reviewed: needs complete overhaul but will NOT use real identity
- Keep Mikecranesync GitHub private, create FactoryLM org for public repos
- White paper author changes to "FactoryLM Research Team"
- **CRITICAL:** Never reference Universal Orlando or Mike's employer in any public content

## Synchronicity Framework (18:49 EST)
- Mike sent massive guide on cultivating synchronicity for business growth
- Created Trello card: https://trello.com/c/VmqpbIxM
- Updated morning brief + evening wrap cron jobs to include synchronicity scanning
- Signal Hunter cron job: autonomous web/Reddit/grant search at 7 PM daily
- Saved guide to projects/synchronicity/SYNCHRONICITY_GUIDE.md

## Mike's Schedule (IMPORTANT)
- **Third shift worker** â€” wakes up ~3:00 PM EST, goes to bed ~10:00 AM EST
- Peak hours: 6 PM - 6 AM EST
- All cron jobs flipped to match this schedule
- "Morning" = 3 PM, "Evening" = 9 AM, "Midday" = 7 PM
